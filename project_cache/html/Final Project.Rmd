---
title: "Final Proejct"
author: "Jiaxiang Peng"
date: "Aug,1st 2020"
output:
  html_document:
    code_folding: hide
    number_sections: false
    toc: yes
    toc_depth: 3
    toc_float: yes
  pdf_document:
    toc: yes
    toc_depth: '3'
---

```{r basic, include=F}
# use this function to conveniently load libraries and work smoothly with knitting
# can add quietly=T option to the require() function
loadPkg = function(x) { if (!require(x,character.only=T, quietly =T)) { install.packages(x,dep=T,repos="http://cran.us.r-project.org"); if(!require(x,character.only=T)) stop("Package not found") } }

# unload/detact package when done using it
unloadPkg = function(pkg, character.only = FALSE) { 
  if(!character.only) { pkg <- as.character(substitute(pkg)) } 
  search_item <- paste("package", pkg,sep = ":") 
  while(search_item %in% search()) { detach(search_item, unload = TRUE, character.only = TRUE) } 
}
```

```{r setup, include=FALSE}
# some of common options (and the defaults) are: 
# include=T, eval=T, echo=T, results='hide'/'asis'/'markup',..., collapse=F, warning=T, message=T, error=T, cache=T, fig.width=6, fig.height=4, fig.dim=c(6,4) #inches, fig.align='left'/'center','right', 
# knitr::opts_chunk$set(warning = F, results = "markup", message = F)
knitr::opts_chunk$set(warning = F, results = "hide", message = F)
# knitr::opts_chunk$set(include = F)
# knitr::opts_chunk$set(echo = TRUE)
options(scientific=T, digits = 3) 
# options(scipen=9, digits = 3) 
# ‘scipen’: integer. A penalty to be applied when deciding to print numeric values in fixed or exponential notation.  Positive values bias towards fixed and negative towards scientific notation: fixed notation will be preferred unless it is more than ‘scipen’ digits wider.
# use scipen=999 to prevent scientific notation at all times
```

```{r outlierKD2}
# Fix outliers
outlierKD2 <- function(df, var, rm=FALSE) { 
    #' Original outlierKD functino by By Klodian Dhana,
    #' https://www.r-bloggers.com/identify-describe-plot-and-remove-the-outliers-from-the-dataset/
    #' Modified to have third argument for removing outliers instead of interactive prompt, 
    #' and after removing outlier, original df will not be changed. The function returns a new df, 
    #' which can be saved as original df name if desired.
    #' Check outliers, and option to remove them, save as a new dataframe. 
    #' @param df The dataframe.
    #' @param var The variable in the dataframe to be checked for outliers
    #' @param rm Boolean. Whether to remove outliers or not.
    #' @return The dataframe with outliers replaced by NA if rm==TRUE, or df if nothing changed
    #' @examples
    #' outlierKD2(mydf, height, FALSE)
    #' mydf = outlierKD2(mydf, height, TRUE)
    #' mydfnew = outlierKD2(mydf, height, TRUE)
    dt = df # duplicate the dataframe for potential alteration
    var_name <- eval(substitute(var),eval(dt))
    na1 <- sum(is.na(var_name))
    m1 <- mean(var_name, na.rm = T)
    par(mfrow=c(2, 2), oma=c(0,0,3,0))
    boxplot(var_name, main="With outliers")
    hist(var_name, main="With outliers", xlab=NA, ylab=NA)
    outlier <- boxplot.stats(var_name)$out
    mo <- mean(outlier)
    var_name <- ifelse(var_name %in% outlier, NA, var_name)
    boxplot(var_name, main="Without outliers")
    hist(var_name, main="Without outliers", xlab=NA, ylab=NA)
    title("Outlier Check", outer=TRUE)
    na2 <- sum(is.na(var_name))
    cat("Outliers identified:", na2 - na1, "\n")
    cat("Propotion (%) of outliers:", round((na2 - na1) / sum(!is.na(var_name))*100, 1), "\n")
    cat("Mean of the outliers:", round(mo, 2), "\n")
    m2 <- mean(var_name, na.rm = T)
    cat("Mean without removing outliers:", round(m1, 2), "\n")
    cat("Mean if we remove outliers:", round(m2, 2), "\n")
    
    # response <- readline(prompt="Do you want to remove outliers and to replace with NA? [yes/no]: ")
    # if(response == "y" | response == "yes"){
    if(rm){
        dt[as.character(substitute(var))] <- invisible(var_name)
        #assign(as.character(as.list(match.call())$dt), dt, envir = .GlobalEnv)
        cat("Outliers successfully removed", "\n")
        return(invisible(dt))
    } else {
        cat("Nothing changed", "\n")
        return(invisible(df))
    }
}
# sample usage
# mlb2 = outlierKD2(mlb, weight, TRUE) # This will remove weight outliers, replace those values by NA, then save it as a new dataframe mlb2
# mlb = outlierKD2(mlb, weight, TRUE) # This will remove weight outliers, replace those values by NA, then REPLACE the dataframe mlb with the new one.
# outlierKD2(mlb, weight, FALSE) # This will NOT remove weight outliers, but it will show the charts with and without outliers nonetheless. 
# outlierKD2(mlb, weight) # same as above, as the last argument is optional, default = FALSE 
```
statecode 1
Test. 4
Total case 6
Death 7
Sleep hour 46.: Does sleep hour relate to total case or death rate?
diabetes  49 
heart disease 52
obesity 54 adult obesity60

######poor health physical unhealthy mentally unhealthy

Smoke 59
drinking 64
liver disease 70 71
#generate data
```{r,data,echo=F}
#counties<-data.frame(read_excel("CountiesDataset.xlsx"))
#tail(counties,n=25)

counties<-data.frame(read.csv("CountiesDataset.csv"))
use<-counties %>%
  select(As.of.4.14.2020,X, X.1,X.4,X.6,X.7,X.8,X.9,X.10,X.46,X.49,X.52,X.54,X.59,X.60,X.64,X.70,X.71)
#str(use)
use1<-use[-1,]
use1$X.46<-as.numeric(as.character(use1$X.46))
use1$X.6<-as.numeric(as.character(use1$X.6))
use1$X.7<-as.numeric(as.character(use1$X.7))
#use1<-as.numeric(as.character(use1))
str(use1$X.46)
summary(use1$X.46) # sleep hour less than 7 
str(use1$X.6)# Total Cases
summary(use1$X.6)
str(use1$X.7)# Death number
summary(use1$X.7)
#str(use1)
```
does sleep hour <7 relate to total cases or death rate?
```{r,removedata,echo=F}
#delete NA value form X.46
q1<-subset(use,is.na(X.46))
nrow(q1)
q2<-subset(use,is.na(X.6))
nrow(q2)
q3<-subset(use,is.na(X.7))
nrow(q3)
loadPkg("dplyr") 
u1=use1 %>% subset(X.46>0)
u2=u1 %>% subset(X.6>0)
u3=u2 %>% subset(X.7>0)
nrow(u1)
nrow(u2)
nrow(u3)
nrow(use1)
u1 %>%
  arrange_(~ desc(X.6)) %>%
  group_by_(~ X) %>%
  head(n = 10)
#slice_max(u1%X.6)
#u1 %>% top_n(10)
```
```{r, nomality,echo=F}
boxplot(u1$X.46, main="sleep hour < 7 percent ", ylab="< 7hour (percent)", col='#0000FF')
loadPkg("ggplot2")
ggplot(u1, aes(y=X.46)) + 
  geom_boxplot() + 
  geom_boxplot( colour="orange", fill="#7777cc", outlier.colour="red", outlier.shape=8, outlier.size=4) +
  labs(title="sleep hour < 7 percent",x="", y = "< 7hour (percent)")
hist(u1$X.46, main="Histogram of sleep hour < 7 percent", col = 'green' ) 
ggplot(data=u1, aes(X.46)) + 
  geom_histogram(breaks=seq(20, 50, by = 2), 
                 col="red", 
                 fill="green", 
                 alpha = .7) + # opacity
  labs(title="Histogram of sleep hour < 7 percent boxplot using `ggplot`") +
  labs(x="< 7hour (percent)", y="Frequency")
qqnorm(u1$X.46, main="Q-Q plot of sodium level of pizza dataset \nSodium quantile vs Normal distribution quantile") 
qqline(u1$X.46)
shapTestSleep = shapiro.test(u1$X.46) # Shapiro-Wilk test for normality
shapTestSleep
shapTestCause = shapiro.test(u1$X.6) # Shapiro-Wilk test for normality
shapTestCause
```

```{r,outlier,echo=F}
pizzaCleanSleep = outlierKD2(u1,X.46,TRUE)
pizzaCleanCausel = outlierKD2(u1,X.6,TRUE)
qqnorm(pizzaCleanSleep$X.46, main="Q-Q plot of sodium level \nwith outlier removed") 
qqline(pizzaCleanSleep$X.46)
qqnorm(pizzaCleanCausel$X.6, main="Q-Q plot of sodium level \nwith outlier removed") 
qqline(pizzaCleanCausel$X.6)
```

```{r,2-variable relation by country,echo=F}
# loadPkg("ggplot2")
ggplot(data=u1)+
  geom_point(mapping = aes(x=X.8, y=X.71, color=X))+
  ggtitle("Scatter plot of baseball player weigth(y, lbs) vs height(x, inches)")
```

```{r,t-test,echo=F}
ttest80 <- t.test(x = u1$X.46, conf.level = 0.80)
ttest80
ttest99 <- t.test(x = u1$X.6, conf.level = 0.99)
ttest99
```


Analysis the time apply stay at home policy effect the Total cases or not 
```{r,Stay at home,echo=F}
u4<-counties %>%
  select(As.of.4.14.2020,X, X.1,X.4,X.6,X.7,X.77,X.78,X.79,X.80,X.81)
u4<-u4[-1,]
u4$X.6<-as.numeric(as.character(u4$X.6))
#str(u4)
u4 = outlierKD2(u4, X.6, TRUE)
Before <- subset(u4,X.80==1)
After <- subset(u4,X.81==1)
admitted_ttest80 = t.test(x = Before$X.6, conf.level = 0.80)
admitted_ttest80
rejected_ttest80 = t.test(x = After$X.6, conf.level = 0.80)
rejected_ttest80
admitted_ttest99 = t.test(x = Before$X.6, conf.level = 0.99)
admitted_ttest99
rejected_ttest99 = t.test(x = After$X.6, conf.level = 0.99)
rejected_ttest99
#u5<-subset(u4,X.80==1)
#use1$X.6<-as.numeric(as.character(use1$X.6))
```

```{r,box,echo=F}
loadPkg("ggplot2")
#u4 = outlierKD2(u4, X.77, TRUE)
#u4 = outlierKD2(u4, X.77, TRUE)
ggplot(data = Before, aes(x=X.77, y=X.6))+
  geom_boxplot(fill = "#0000aa", alpha = .7)+
  labs(title="TotalCases Boxplot for Before first Case Stay at home") +
  labs(x="First Cases", y="Total Cases") 
ggplot(data = After, aes(x=X.77, y=X.6))+
  geom_boxplot(fill="#FF9933", alpha = .7)+
  labs(title="TotalCases Boxplot for After first Case Stay at home") +
  labs(x="First Cases", y="Total Cases") 
```
Compare two diagrams, The Total cases higher if After First Case Stay at home

```{r nomal}
ggplot(data=u4, aes(X.6)) + 
  geom_histogram(breaks=seq(2, 80, by = 1), 
                 col="red", 
                 fill="#0000aa", 
                 alpha = .7) + # opacity
  labs(title="TotalCases Boxplot for Before first Case Stay at home") +
  labs(x="Total Cases", y="Frequency") 

qqnorm(Before$X.6, main="otalCases Boxplot for Before first Case Stay at home)", ylab = "Total Casess") 
qqline(Before$X.6)

ggplot(data=u4, aes(X.6)) + 
  geom_histogram(breaks=seq(2, 80, by = 1), 
                 col="red", 
                 fill="#0000aa", 
                 alpha = .7) + # opacity
  labs(title="GRE Histogram for rejected student\n (outliers removed from all applicants)") +
  labs(x="Total Cases", y="Frequency") 

  qqnorm(After$X.6, main="TotalCases Boxplot for After first Case Stay at home", ylab = "Total Cases") 
qqline(After$X.6)
```
Not quite normal for the Total cases distribution


```{r,corelation,echo=F}
loadPkg("corrplot")
u5<-u4[ , -which(colnames(u4) %in% c("As.of.4.14.2020","X","X.1","X.77","X.78","X.4"))]
#u6<-u1[ , -which(colnames(u1) %in% c("As.of.4.14.2020","X","X.1"))]
#u5$X.4<-as.numeric(as.character(u5$X.4))

u5$X.7<-as.numeric(as.character(u5$X.7))
u5$X.79<-as.numeric(as.character(u5$X.79))
u5$X.80<-as.numeric(as.character(u5$X.80))
u5$X.81<-as.numeric(as.character(u5$X.81))
u10=u5 %>% subset(X.6>0)
u5_corr<-cor(u10)
corrplot(u5_corr,method="circle")
loadPkg("leaps")
reg.leaps2 <- regsubsets(X.6~., data = u10, nbest = 1, method = "exhaustive")  # leaps, 
plot(reg.leaps2, scale = "bic", main = "BIC")
plot(reg.leaps2, scale = "adjr2", main = "Adjusted R^2")
lm.u5<-lm(X.6~X.7+X.79+X.81,data = u5)
summary(lm.u5)
faraway::vif(lm.u5)
```
As result, X.7, X.79 and X.81 are best model.

Test correlation for variables.
```{r,corr,echo=F}
u6<-u1[ , -which(colnames(u1) %in% c("As.of.4.14.2020","X","X.1","X.4"))]
#u6$X.4<-as.numeric(as.character(u6$X.4))
u6$X.8<-as.numeric(as.character(u6$X.8))
u6$X.9<-as.numeric(as.character(u6$X.9))
u6$X.10<-as.numeric(as.character(u6$X.10))
u6$X.49<-as.numeric(as.character(u6$X.49))
u6$X.52<-as.numeric(as.character(u6$X.52))
u6$X.54<-as.numeric(as.character(u6$X.54))
u6$X.59<-as.numeric(as.character(u6$X.59))
u6$X.60<-as.numeric(as.character(u6$X.60))
u6$X.64<-as.numeric(as.character(u6$X.64))
u6$X.70<-as.numeric(as.character(u6$X.70))
u6$X.71<-as.numeric(as.character(u6$X.71))
u6=u6 %>% subset(X.49>0)
u6=u6 %>% subset(X.52>0)
u6=u6 %>% subset(X.54>0)
u6=u6 %>% subset(X.70>0)
u6=u6 %>% subset(X.71>0)
u6_corr<-cor(u6)
corrplot(u6_corr,method="circle")

nrow(u6)
```
It shows population and liver disease are highly correlated Total cases and death number are highly correlated 

Use exhaustive method for feature selection 
```{r,q10,echo=F}
loadPkg("leaps")
reg.leaps <- regsubsets(X.6~., data = u6, nbest = 1, method = "exhaustive")  # leaps, 
plot(reg.leaps, scale = "bic", main = "BIC")
plot(reg.leaps, scale = "adjr2", main = "Adjusted R^2")
lm.u6<-lm(X.6~X.7+X.8+X.9+X.54+X.70+X.71,data = u6)
summary(lm.u6)
faraway::vif(lm.u6)
```
As we can see, X.7, X.8 ,X.71 are best for BIC, X.7 X.8, X.9, X.54 X.70, X.71 are best for Adjusted R^2 

But X.9, X.54 and X.70 p_value >0.05, so delete them 

Also, VIF value shows 8 and 71 are highlly correlated, so delete one variable 

Try mallow Cp X.8, X.54, X.71 are the best model. 
```{r,cp,echo=F}
loadPkg("carData")
loadPkg("car")
layout(matrix(1:2, ncol = 2))
## Adjusted R2
#res.legend <-
#    subsets(reg.leaps, statistic="adjr2", legend = FALSE, min.size = 3, main = "Adjusted R^2")
## Mallow Cp
res.legend <-
    subsets(reg.leaps, statistic="cp", legend = FALSE, min.size=1, main = "Mallow Cp")
abline(a = 1, b = 1, lty = 2)
    subsets(reg.leaps, statistic="cp", legend = FALSE, min.size=4, main = "Mallow Cp")
abline(a = 1, b = 1, lty = 2)
#lm.TU6<-lm(Total.Users~Hour+Temperature.Feels.F+Humidity,data = bike)
#summary(lm.TU6)
#faraway::vif(lm.TU6)
```

